from vehicle.models import Product
from django.views import View
from django.db.models import F
from django.http import HttpResponse, JsonResponse, Http404

import json
from utils.generate_data import generate_slab_number


class ProductCreateView(View):
    model = Product
    content = {}

    def post(self, request, *args, **kwargs):
        obj = None

        name = request.GET.get("name", None)
        price = request.GET.get("price", None)
        model = request.GET.get("model", None)
        color = request.GET.get("color", None)
        branch = request.GET.get("branch", None)
        description = request.GET.get("description", None)

        p = self.model.validate_price(price)
        n = self.model.validate_name(name)
        m = self.model.validate_model(model)
        c = self.model.validate_color(color)
        d = self.model.validate_description(description)
        b = self.model.validate_branch(branch)

        if p and n and m and c and d and b:
            obj = self.model.objects.create(
                price=price,
                name=name,
                model=model,
                color=color,
                description=description,
                branch=branch,
                chassis=generate_slab_number(15),
                slab=generate_slab_number(4, 'BRA')
            )

        if obj:
            obj.save()
            self.content['results'] = []
            self.content['count'] = 1

            self.content['results'].append({
                "branch": obj.branch,
                "name": obj.name,
                "model": obj.model,
                "description": obj.description,
                "color": obj.color,
                "price": obj.price,
                "chassis": obj.chassis,
                "slab": obj.slab,
                "id": obj.pk
            })

        else:
            self.content['count'] = 0

        return JsonResponse(
            data=self.content,
            status=200
        )


class ProductDetailView(View):

    model = Product
    content = {}

    def get(self, request, pk=None):

        ids = request.GET.get("ids", None)

        if pk is None:
            return Http404("Product id is null")

        if ids:
            ids = ids.split(',')

        if pk != 0:
            obj = Product.objects.filter(pk=pk)
            if len(obj) > 0:
                self.content['results'] = [obj[0].attributes]
                self.content['count'] = 1
            else:
                self.content['results'] = [
                    {
                        "message": "No Items on base"
                    }
                ]
                self.content['count'] = 0

            return JsonResponse(
                data=self.content,
                status=200
            )

        if (pk == 0) and (len(ids) > 1):
            qs = Product.objects.filter(pk__in=ids)
            self.content['results'] = []

            for product in qs:
                self.content['results'].append(product.attributes)

            self.content['count'] = qs.count()

            return JsonResponse(
                data=self.content,
                status=200
            )

        return JsonResponse({
            "results": [],
            "count": 0
        }, status=200)


class ProductDeleteView(View):

    model = Product
    content = {}

    def post(self, request, pk=None):
        ids = request.GET.get("ids", None)

        if pk is None:
            return Http404("Invalid request")

        if ids:
            ids = ids.split(',')

        if pk != 0:
            try:
                Product.objects.filter(pk=pk).delete()

                return HttpResponse(status=200, content=f"Model with id: {pk} was deleted!")

            except:
                return HttpResponse("Erroor")

        if pk == 0 and len(ids) > 1:
            try:
                Product.objects.filter(pk__in=ids).delete()

                return HttpResponse(status=200, content=f"Models with ids: {ids} were deleted!")

            except Exception as e:
                return Http404(f"{e.args}")

        return HttpResponse("Error")


class ProductListView(View):
    model = Product
    content = {}

    def get(self, request):

        qs = self.model.objects.all()
        self.content['results'] = [
            obj.attributes for obj in qs
        ]

        self.content['count'] = qs.count()

        return JsonResponse(
            data=self.content,
            status=200
        )


class ProductUpdateView(View):

    model = Product
    content = {}

    def post(self, request, pk):
        name = request.GET.get("name", None)
        slab = request.GET.get("slab", None)
        chassis = request.GET.get("chassis", None)
        price = request.GET.get("price", None)
        model = request.GET.get("model", None)
        color = request.GET.get("color", None)
        branch = request.GET.get("branch", None)
        description = request.GET.get("description", None)

        p = self.model.validate_price(price) if price else False
        n = self.model.validate_name(name) if name else False
        m = self.model.validate_model(model) if model else False
        c = self.model.validate_color(color) if color else False
        d = self.model.validate_description(description) if description else False
        b = self.model.validate_branch(branch) if branch else False
        s = True if slab else False
        e = True if chassis else False

        update_fields = []

        if pk is None:
            return Http404("Error")

        if pk != 0:
            obj = self.model.objects.filter(pk=pk)

            Product.objects.filter(pk=pk)

            if p:
                obj[0].price = price
                update_fields.append('price')
            if n:
                obj[0].name = name
                update_fields.append('name')
            if m:
                obj[0].model = model
                update_fields.append('model')
            if c:
                obj[0].color = color
                update_fields.append('color')
            if d:
                obj[0].description = description
                update_fields.append('description')
            if b:
                obj[0].branch = branch
                update_fields.append('branch')
            if s:
                obj[0].slab = slab
                update_fields.append('slab')
            if e:
                obj[0].chassis = chassis
                update_fields.append('chassis')

            obj[0].save(update_fields=update_fields, force_update=True)

            self.content['results'] = [obj[0].attributes]
            self.content['count'] = 1

            return JsonResponse(
                data=self.content,
                status=200
            )


